<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>City Flip</title>

  <style>
    :root{
      --bg1:#1a2a44; --bg2:#0b1220;
      --panel: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);
      --text:#fff; --muted: rgba(255,255,255,0.72);
      --accent:#4ade80; --danger:#fb7185;
      --radius:16px;
      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      align-items:center;
      padding: calc(16px + var(--safeT)) calc(16px + var(--safeR)) calc(16px + var(--safeB)) calc(16px + var(--safeL));
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .app{width:min(540px,100%); display:grid; gap:12px;}
    .topbar{
      display:grid;
      grid-template-columns: 1fr auto auto auto auto auto;
      gap:10px;
      align-items:center;
      padding:12px 12px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .logo{
      width:34px; height:34px;
      display:grid; place-items:center;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.12);
      font-size:18px;
    }
    .sub{font-size:12px;color:rgba(255,255,255,0.70);margin-top:2px}
    .stat{ text-align:right; line-height:1.1; min-width: 62px; }
    .stat .label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px;}
    .stat .value{font-size:17px; font-weight:900;}

    .iconbtn{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color:#fff;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 900;
      cursor: pointer;
      line-height: 1;
      touch-action: manipulation;
    }
    .iconbtn:active{ transform: translateY(1px); }
    .iconbtn[aria-pressed="true"]{ outline:2px solid rgba(74,222,128,0.35); }

    .frame{
      position:relative;
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: calc(var(--radius) + 6px);
      overflow:hidden;
      aspect-ratio: 9/16;
      box-shadow: 0 24px 80px rgba(0,0,0,0.35);
      touch-action: manipulation;
    }
    canvas{width:100%; height:100%; display:block;}

    .toast{
      position:absolute; top:12px; left:50%;
      transform:translateX(-50%);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      opacity:0;
      transition: opacity 160ms ease, transform 160ms ease;
      pointer-events:none;
      backdrop-filter: blur(8px);
      z-index: 3;
      white-space: nowrap;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(2px); }

    .overlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      padding:18px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.10), rgba(0,0,0,0.45));
      z-index: 4;
    }
    .card{
      width:min(440px,92%);
      padding:16px;
      border-radius:18px;
      background: rgba(10, 18, 32, 0.78);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      text-align:center;
    }
    .card h1{margin:0 0 6px; font-size:22px;}
    .card p{margin:0 0 12px; color:var(--muted); font-size:14px; line-height:1.35;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnrow{display:grid; gap:10px;}
    .btn{
      width:100%;
      border:0; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900; font-size:16px;
      color:#062312;
      background: linear-gradient(180deg, #86efac, #22c55e);
    }
    .btn.secondary{
      color:#0b1220;
      background: linear-gradient(180deg, #e5e7eb, #cbd5e1);
    }
    .pill{
      display:inline-block;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.85);
      margin: 6px 4px 0 4px;
    }
    .settings{
      text-align:left;
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .row:last-child{border-bottom:none}
    .row label{font-size:13px;color:rgba(255,255,255,0.88)}
    select, input[type="checkbox"]{ transform: scale(1.1); }
    select{
      background: rgba(255,255,255,0.10);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }
    .footer{ text-align:center; font-size:12px; color: rgba(255,255,255,0.65); }

    /* High contrast */
    .hc .topbar,.hc .card{border-color: rgba(255,255,255,0.30)}
    .hc .frame{border-color: rgba(255,255,255,0.24)}
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üèôÔ∏è</div>
        <div>
          <div style="font-size:18px;">City Flip</div>
          <div class="sub" id="modeLabel">Mode: Easy ‚Ä¢ Classic ‚Ä¢ Level 1</div>
        </div>
      </div>

      <div class="stat">
        <div class="label">Score</div>
        <div class="value" id="score">0</div>
      </div>

      <div class="stat">
        <div class="label">Best</div>
        <div class="value" id="best">0</div>
      </div>

      <div class="stat">
        <div class="label">Streak</div>
        <div class="value" id="streak">0</div>
      </div>

      <button class="iconbtn" id="pauseBtn" title="Pause" aria-label="Pause">‚è∏</button>
      <button class="iconbtn" id="settingsBtn" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
    </div>

    <div class="frame" id="frame">
      <canvas id="game"></canvas>
      <div class="toast" id="toast">Perfect!</div>

      <div class="overlay" id="overlay" aria-live="polite">
        <div class="card" id="menuCard">
          <h1>Build the skyline</h1>
          <p>Tap to drop blocks. Overhang gets cut off. Miss the stack = game over (except Zen).</p>

          <div class="grid2">
            <button class="btn secondary" id="easyBtn">Easy</button>
            <button class="btn secondary" id="hardBtn">Hard</button>
          </div>

          <div class="btnrow" style="margin-top:10px;">
            <button class="btn" id="startBtn">Start Classic</button>
            <button class="btn secondary" id="dailyBtn">Daily Challenge</button>
            <button class="btn secondary" id="zenBtn">Zen Mode</button>
            <button class="btn secondary" id="installBtn" style="display:none;">Install App</button>
          </div>

          <div style="margin-top:10px;">
            <span class="pill" id="achPill">Achievements: 0</span>
            <span class="pill" id="dailyPill">Daily: not played</span>
          </div>

          <p style="margin-top:10px;color:rgba(255,255,255,0.60);font-size:12px;">
            Perfect = extra points + streak. Every 3 perfects grants a bonus point. Levels ramp difficulty.
          </p>
        </div>
      </div>
    </div>

    <div class="footer">City Flip ‚Ä¢ Ultimate PWA build</div>
  </div>

  <script>
    // ---------- SAFE BOOT ----------
    try {
      // DOM
      const root = document.getElementById("appRoot");
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const overlay = document.getElementById("overlay");
      const toast = document.getElementById("toast");

      const scoreEl = document.getElementById("score");
      const bestEl = document.getElementById("best");
      const streakEl = document.getElementById("streak");
      const modeLabel = document.getElementById("modeLabel");

      const pauseBtn = document.getElementById("pauseBtn");
      const settingsBtn = document.getElementById("settingsBtn");
      const frame = document.getElementById("frame");

      // Save menu template (so menu can be rebuilt safely any time)
      const MENU_TEMPLATE = overlay.innerHTML;

      // Keys
      const KEYS = {
        best: "cityflip_best_ultra_v1",
        mode: "cityflip_mode_ultra_v1",            // easy|hard
        sound: "cityflip_sound_ultra_v1",          // 1 on, 0 off
        music: "cityflip_music_ultra_v1",          // 1 on, 0 off
        haptics: "cityflip_haptics_ultra_v1",      // 1 on, 0 off
        lefthand: "cityflip_lefthand_ultra_v1",    // 1 on, 0 off
        contrast: "cityflip_contrast_ultra_v1",    // 1 on, 0 off
        motion: "cityflip_motion_ultra_v1",        // 1 reduced motion, 0 normal
        achievements: "cityflip_ach_ultra_v1",
        daily: "cityflip_daily_ultra_v1",
        dailyBest: "cityflip_dailybest_ultra_v1"
      };

      // Stored
      let best = Number(localStorage.getItem(KEYS.best) || 0);
      bestEl.textContent = best;

      let mode = (localStorage.getItem(KEYS.mode) || "easy");
      let soundOn = (localStorage.getItem(KEYS.sound) !== "0");     // default on
      let musicOn = (localStorage.getItem(KEYS.music) === "1");     // default off
      let hapticsOn = (localStorage.getItem(KEYS.haptics) !== "0"); // default on
      let leftHand = (localStorage.getItem(KEYS.lefthand) === "1");
      let hiContrast = (localStorage.getItem(KEYS.contrast) === "1");
      let reducedMotion = (localStorage.getItem(KEYS.motion) === "1");

      if (hiContrast) root.classList.add("hc");

      // Achievements
      const ACH = {
        FIRST_PERFECT: "FIRST_PERFECT",
        TEN_SCORE: "TEN_SCORE",
        FIFTY_SCORE: "FIFTY_SCORE",
        DAILY_PLAY: "DAILY_PLAY",
        HARD_25: "HARD_25"
      };
      function loadAch() {
        try { return JSON.parse(localStorage.getItem(KEYS.achievements) || "[]"); } catch { return []; }
      }
      function saveAch(list) {
        localStorage.setItem(KEYS.achievements, JSON.stringify(list));
        const pill = overlay.querySelector("#achPill");
        if (pill) pill.textContent = `Achievements: ${list.length}`;
      }
      let achievements = loadAch();

      function showToast(text, danger=false) {
        toast.textContent = text;
        toast.style.borderColor = danger ? "rgba(251,113,133,0.45)" : "rgba(255,255,255,0.14)";
        toast.style.background = danger ? "rgba(251,113,133,0.16)" : "rgba(255,255,255,0.10)";
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=> toast.classList.remove("show"), 650);
      }
      function unlock(code, label) {
        if (achievements.includes(code)) return;
        achievements.push(code);
        localStorage.setItem(KEYS.achievements, JSON.stringify(achievements));
        showToast(`üèÜ ${label}`);
      }

      // Modes
      const MODES = {
        easy: { name: "Easy", baseSpeed: 2.2, ramp: 0.030, maxAdd: 2.2, tolStart: 5, tolMin: 3, dropSpeed: 16, comboEvery: 3 },
        hard: { name: "Hard", baseSpeed: 2.8, ramp: 0.050, maxAdd: 3.4, tolStart: 4, tolMin: 2, dropSpeed: 20, comboEvery: 3 }
      };

      // PWA install prompt
      let deferredPrompt = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = overlay.querySelector("#installBtn");
        if (btn) btn.style.display = "block";
      });

      // iOS A2HS hint
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;

      // Service worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => navigator.serviceWorker.register("/sw.js").catch(()=>{}));
      }

      // Audio (SFX + optional ambient music)
      let audioCtx = null;
      let musicNode = null;
      let musicGain = null;

      function initAudio() {
        if (!soundOn && !musicOn) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") audioCtx.resume();
      }

      function beep({ freq=440, dur=0.06, type="sine", vol=0.06 } = {}) {
        if (!soundOn) return;
        if (!audioCtx) return;
        const t = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        // tiny detune to prevent fatigue
        const detune = (Math.random() * 10) - 5;
        o.frequency.setValueAtTime(freq + detune, t);

        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(vol, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t + dur + 0.02);
      }

      function sfx(name, streak=0) {
        if (!soundOn) return;
        // adaptive pitch: streak rewards
        const boost = Math.min(220, streak * 22);
        if (name === "place")  beep({ freq: 520 + boost*0.10, dur: 0.045, type: "square", vol: 0.04 });
        if (name === "slice")  beep({ freq: 330, dur: 0.06, type: "sawtooth", vol: 0.035 });
        if (name === "perfect") {
          beep({ freq: 740 + boost*0.20, dur: 0.05, type: "triangle", vol: 0.06 });
          setTimeout(() => beep({ freq: 990 + boost*0.20, dur: 0.06, type: "triangle", vol: 0.06 }), 55);
        }
        if (name === "gameover") beep({ freq: 180, dur: 0.14, type: "sawtooth", vol: 0.05 });
        if (name === "pause") beep({ freq: 260, dur: 0.07, type: "sine", vol: 0.03 });
        if (name === "resume") beep({ freq: 460, dur: 0.06, type: "sine", vol: 0.03 });
      }

      function haptic(pattern=[10]) {
        if (!hapticsOn) return;
        if (navigator.vibrate) navigator.vibrate(pattern);
      }

      function startMusic() {
        if (!musicOn) return;
        if (!audioCtx) return;

        stopMusic();

        // Simple ambient pad: low sine + triangle mix
        const base = audioCtx.createOscillator();
        base.type = "sine";
        base.frequency.value = 110;

        const harm = audioCtx.createOscillator();
        harm.type = "triangle";
        harm.frequency.value = 165;

        musicGain = audioCtx.createGain();
        musicGain.gain.value = 0.0001;

        base.connect(musicGain);
        harm.connect(musicGain);
        musicGain.connect(audioCtx.destination);

        const t = audioCtx.currentTime;
        musicGain.gain.exponentialRampToValueAtTime(0.015, t + 0.4);

        base.start();
        harm.start();

        musicNode = { base, harm };
      }

      function stopMusic() {
        if (musicNode) {
          try { musicNode.base.stop(); } catch {}
          try { musicNode.harm.stop(); } catch {}
          musicNode = null;
        }
        if (musicGain) {
          try { musicGain.disconnect(); } catch {}
          musicGain = null;
        }
      }

      // Canvas sizing
      function resizeCanvasToDisplay() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const rect = canvas.getBoundingClientRect();
        const w = Math.floor(rect.width * dpr);
        const h = Math.floor(rect.height * dpr);
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w; canvas.height = h;
        }
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);
        return { w: rect.width, h: rect.height };
      }

      // Game state
      let running=false, paused=false, dropInProgress=false, gameOverShown=false;
      let score=0, level=1, streak=0;
      let runType="classic"; // classic|daily|zen
      let dailySeed=0;
      let rafId=null;

      const state = {
        w:0,h:0,groundY:0,
        stack:[], active:null,
        cameraY:0,
        speed:2.2,
        perfectTolerance:4,
        blockH:26,
        baseW:170,
        dropSpeed:16,
        gapY:70
      };

      // Camera shake (disabled in reduced motion)
      let shake = 0;
      function triggerShake(p=3){ if (!reducedMotion) shake = Math.max(shake, p); }

      // Deterministic RNG for daily
      function mulberry32(a){
        return function() {
          let t = a += 0x6D2B79F5;
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        }
      }
      function todaySeed() {
        const d = new Date();
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const day = d.getDate();
        return (y*10000 + m*100 + day) >>> 0;
      }

      function runLabel() {
        if (runType === "daily") return "Daily";
        if (runType === "zen") return "Zen";
        return "Classic";
      }
      function applyModeLabel() {
        modeLabel.textContent = `Mode: ${MODES[mode].name} ‚Ä¢ ${runLabel()} ‚Ä¢ Level ${level}`;
      }

      function makeBlock(x,y,w,h,color,moving=false){
        return { x,y,w,h,color,moving,dir:1,vx:0,vy:0 };
      }

      // Debris
      const debris = [];
      function addDebris(p){ debris.push(p); if (debris.length>14) debris.shift(); }
      function updateDebris(){
        for (let i = debris.length-1; i>=0; i--){
          const p = debris[i];
          p.vy += 0.75;
          p.x += p.vx;
          p.y += p.vy;
          if (p.y - state.cameraY > state.h + 260) debris.splice(i,1);
        }
      }

      // Progression
      function computeLevel(){ level = Math.max(1, Math.floor(score/10) + 1); }
      function applyDifficulty(){
        const m = MODES[mode];
        const add = Math.min(m.maxAdd, score * m.ramp);
        const levelAdd = Math.min(1.6, (level-1) * 0.12);
        state.speed = m.baseSpeed + add + levelAdd;

        const tighten = Math.floor(score / 20) + Math.floor((level-1)/2);
        state.perfectTolerance = Math.max(m.tolMin, m.tolStart - tighten);

        state.dropSpeed = m.dropSpeed;
      }

      function resetGame(){
        score=0; streak=0; level=1;
        dropInProgress=false; gameOverShown=false;
        debris.length=0;
        scoreEl.textContent="0";
        streakEl.textContent="0";
        applyModeLabel();

        const {w,h} = resizeCanvasToDisplay();
        state.w=w; state.h=h;
        state.groundY=h-90;
        state.stack=[];
        state.cameraY=0;

        let baseW = state.baseW;
        if (runType === "daily") {
          const r = mulberry32(dailySeed)();
          baseW = Math.round(state.baseW + (r*22 - 11));
        }
        const baseX = (w - baseW)/2;
        state.stack.push(makeBlock(baseX, state.groundY - state.blockH, baseW, state.blockH, "rgba(255,255,255,0.14)"));
        spawnActive();
      }

      function spawnActive(){
        computeLevel();
        applyDifficulty();
        applyModeLabel();

        const top = state.stack[state.stack.length-1];
        let nextW = top.w;

        if (runType === "daily") {
          const rng = mulberry32(dailySeed + score + 101);
          const tweak = (rng()*10)-5;
          nextW = Math.max(60, nextW + tweak);
        }

        const targetY = top.y - state.blockH;
        const startY = targetY - state.g
